machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  php:
    version: 7.0.7
  services:
    - docker
  hosts:
    www.test.ci: 127.0.0.1
  environment:
    COMPOSER_DISCARD_CHANGES: true
general:
  artifacts:
    - "build/"
    - "tmp/"
dependencies:
  pre:
    - sudo pip install docker-compose
    - docker-compose pull
    - docker-compose up -d
    - ./etc/circleci/setup-app-config.sh
    - ./etc/circleci/setup-app-permissions.sh
  override:
    - docker-compose run workspace php /usr/local/bin/composer.phar install
  post:
    - ./etc/circleci/setup-app-data.sh
  cache_directories:
    - "vendor"
    - "bin"
test:
  override:
    - docker-compose run workspace php ./bin/phpunit
    - docker-compose run workspace php ./bin/phpspec run --no-interaction
    - docker-compose run workspace php ./bin/behat --strict
    - ant phpcs-task -emacs
    - ant phpmd-task -emacs
    - ant php-cs-fixer-check -emacs
    #- ./bin/coveralls
    #- ./bin/test-reporter